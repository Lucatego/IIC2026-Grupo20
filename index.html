<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Horas vistas en Twitch por trimestre (eje X anual)</title>
  <script src="https://cdn.plot.ly/plotly-2.34.0.min.js"></script>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div id="chart"></div>

  <script>
    const Q_START_MONTH = { 1: '01', 2: '04', 3: '07', 4: '10' };

    function yearQToDateStr(Year_Q) {
      const [yStr, qStr] = Year_Q.split('-Q');
      const y = Number(yStr);
      const q = Number(qStr);
      const mm = Q_START_MONTH[q] || '01';
      return `${y}-${mm}-01`;
    }

    const SCALE = 1e9;
    const UNIT_LABEL = 'Miles de millones de horas';

    fetch('Dataset/datos_limpios.json')
      .then(r => r.json())
      .then(rows => {
        rows.sort((a,b) => {
          const [ya, qa] = a.Year_Q.split('-Q').map(Number);
          const [yb, qb] = b.Year_Q.split('-Q').map(Number);
          return ya - yb || qa - qb;
        });

        const x = rows.map(d => yearQToDateStr(d.Year_Q));
        const y = rows.map(d => Number(d.Hours_watched) / SCALE);
        const quarterLabel = rows.map(d => d.Year_Q);

        // Serie principal (negra)
        const traceMain = {
          type: 'scatter',
          mode: 'lines',
          x, y,
          line: { width: 3, color: '#0a0a0ac8' },
          marker: { size: 7, color: '#0a0a0ac8' },
          customdata: quarterLabel,
          hovertemplate: 'Periodo: %{customdata}<br>Valor: %{y:,.2f} ' + UNIT_LABEL + '<extra></extra>',
          name: ''
        };

        // --- Tramo resaltado 2020Q1–2020Q2 ---
        const idxQ1 = rows.findIndex(d => d.Year_Q === "2020-Q1");
        const idxQ2 = rows.findIndex(d => d.Year_Q === "2020-Q2");
        let traceHighlight1 = null;
        if (idxQ1 !== -1 && idxQ2 !== -1) {
          traceHighlight1 = {
            type: 'scatter',
            mode: 'lines+markers',
            x: [x[idxQ1], x[idxQ2]],
            y: [y[idxQ1], y[idxQ2]],
            line: { width: 4, color: '#a340f7' },
            marker: { size: 9, color: '#a340f7' },
            customdata: [quarterLabel[idxQ1], quarterLabel[idxQ2]],
            hovertemplate: 'Periodo: %{customdata}<br>Valor: %{y:,.2f} ' + UNIT_LABEL + '<extra></extra>',
            name: ''
          };
        }

        // --- Tramo resaltado 2020Q4–2021Q1–2021Q2 ---
        const idxQ4 = rows.findIndex(d => d.Year_Q === "2020-Q4");
        const idx21Q1 = rows.findIndex(d => d.Year_Q === "2021-Q1");
        const idx21Q2 = rows.findIndex(d => d.Year_Q === "2021-Q2");
        let traceHighlight2 = null;
        if (idxQ4 !== -1 && idx21Q1 !== -1 && idx21Q2 !== -1) {
          traceHighlight2 = {
            type: 'scatter',
            mode: 'lines+markers',
            x: [x[idxQ4], x[idx21Q1], x[idx21Q2]],
            y: [y[idxQ4], y[idx21Q1], y[idx21Q2]],
            line: { width: 4, color: '#a340f7' },
            marker: {
              size: [9, 0, 9],   // invisible en el medio (2021Q1)
              color: '#a340f7',
              opacity: 1,
              line: { width: 0 }
            },
            customdata: [quarterLabel[idxQ4], quarterLabel[idx21Q1], quarterLabel[idx21Q2]],
            hovertemplate: 'Periodo: %{customdata}<br>Valor: %{y:,.2f} ' + UNIT_LABEL + '<extra></extra>',
            name: ''
          };
        }

        const layout = {
          title: {
            text: '<b>Horas vistas en Twitch por trimestre</b>',
            font: { family: 'Arial, sans-serif', size: 28, color: '#333' }
          },
          xaxis: {
            type: 'date',
            tickformat: '%Y',
            dtick: 'M12',
            ticks: 'outside',
            showgrid: false
          },
          yaxis: {
            title: UNIT_LABEL,
            rangemode: 'tozero',
            tickformat: ',.2f',
            showgrid: false,
            showline: true,
          },
          margin: { l: 70, r: 20, t: 80, b: 80 },
          showlegend: false
        };

        const data = [traceMain];
        if (traceHighlight1) data.push(traceHighlight1);
        if (traceHighlight2) data.push(traceHighlight2);

        Plotly.newPlot('chart', data, layout, { staticPlot: true, responsive: true });
      })
      .catch(err => {
        console.error(err);
        document.getElementById('chart').innerHTML = 'Error cargando Dataset/datos_limpios.json';
      });
  </script>
</body>
</html>